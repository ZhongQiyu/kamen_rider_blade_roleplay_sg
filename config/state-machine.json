{
  "Comment": "A state machine that processes and transcribes audio files",
  "StartAt": "ProcessAudioFiles",
  "States": {
    "ProcessAudioFiles": {
      "Type": "Map",
      "ItemsPath": "$.audioFiles",
      "Iterator": {
        "StartAt": "ProcessSingleAudioFile",
        "States": {
          "ProcessSingleAudioFile": {
            "Type": "Task",
            "Resource": "arn:aws:lambda:us-west-2:123456789012:function:processAudio",
            "Retry": [
              {
                "ErrorEquals": ["Lambda.ServiceException", "Lambda.AWSLambdaException"],
                "IntervalSeconds": 2,
                "MaxAttempts": 3,
                "BackoffRate": 2.0
              }
            ],
            "Catch": [
              {
                "ErrorEquals": ["States.ALL"],
                "Next": "ErrorHandling"
              }
            ],
            "End": true
          }
        }
      },
      "Next": "CheckTranscription"
    },
    "CheckTranscription": {
      "Type": "Wait",
      "Seconds": 60,
      "Next": "CheckStatus"
    },
    "CheckStatus": {
      "Type": "Task",
      "Resource": "arn:aws:lambda:us-west-2:123456789012:function:checkTranscriptionStatus",
      "Catch": [
        {
          "ErrorEquals": ["States.ALL"],
          "Next": "ErrorHandling"
        }
      ],
      "End": true
    },
    "ErrorHandling": {
      "Type": "Fail",
      "Error": "AudioProcessingFailed",
      "Cause": "The audio processing task failed."
    }
  }
}
